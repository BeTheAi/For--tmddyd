<!doctype html>
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

    <title>글 조회</title>
  </head>
  <body>
    <%- include ("./nav.ejs") %>


	<div class="container">
		<h4 class="container mt-4"><strong><%= posts._doc.title %></strong></h4>
		<div class="float-right">
		<% if(login_success && posts.writer.name == user.name) { %>
			<div class="dropdown">
			  <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				☰
			  </button>
			  <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
				<button class="dropdown-item" type="button" id='edit' data-id='<%= posts._id %>'>edit</button>
				<button class="dropdown-item" type="button" id='delete' data-id='<%= posts._id %>'>delete</button>
			  </div>
			</div>
		<% } %>
		writer : <%= posts.writer.name %>
		</div><br>
		<ul class="list-group">
			<li class="list-group-item">
			<p> <%= posts._doc.contents %> </p>
			<br>
			</li>
		</ul>
	
		<br>
		<% if(posts._doc.imageUrl !== '') { %>
			<div class="text-center">
				<img src="/<%=posts._doc.imageUrl %>" class="rounded" alt="이미지를 불러오지 못했습니다.">
			</div>
		<% } %>
		<% if (login_success) { %>
			<div class="comments">
				<h4>댓글<span class="count"><span id="commentCount65_0"></span></span></h4>
				<div class="comment-list">
					<% for (var i = 0; i < posts._doc.comments.length; i++) { %>
						<div class="comment">
							<div class="sixteen wide column">
								<div class="ui header">
									<h4 class="ui left aligned header">
										<%= posts._doc.comments[i].contents %>
									</h4>
									<h6 class="ui right aligned orange header" style="font-size: small;">
										작성자 : <%= writer[i] %>
									</h6>
									<h6 class="ui right aligned orange header" style="font-size: x-small;">
										작성 시간 : <%= created[i] %>
									</h6>
								</div>
							</div>
						</div>
					<% } %>
				</div>
				<br>
				<form action="/process/addcomment" method="POST">
					<div class="field">
						<label>댓글 달기</label>
						<br><input type="text" name="contents" placeholder="enter your comment">
					</div>
					<input hidden type="text" name="writer" value="<%= user._id %>">
					<input hidden type="text" name="id" value="<%= posts._doc._id %>">

					<br><input class="btn btn-outline-success btn-sm" type="submit" value="Enter" name="" />
				</form>
			</div>

		<% } else { %>
			<div class="alert alert-warning">댓글 조회 및 작성은 로그인 하신 후 이용할 수 있는 기능입니다.</div>
		<% } %>
		
		
		 <br><br><button type="button" class="btn btn-light" onclick='location.href="/listpost"'>Back</button>
	</div>		
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

	<script>
		
		$('#edit').click( (e) => {
			var postNum = e.target.dataset.id;
			$.ajax({
				method : 'GET',
				url : '/process/edit/' + postNum
			}).done( (results) => {
				console.log('call view');
				// Contents 영역 제거
				$('.container.mt-4.delsec').children().remove();
				// Contents 영역 교체
				$('.container.mt-4.delsec').html(results);
				console.log(results);
			}).fail( (xhr, textStatus, errThrown) => {
				console.log("서버에서 보내온 오류 정보 : ", xhr, textStatus, errThrown);
			});
		})
		
		$('#delete').click( (e) => {
			if(confirm('정말 게시물을 삭제하시겠습니까?')) {
				var postNum = e.target.dataset.id;
				$.ajax({
					method : 'DELETE',
					url : '/process/delete',
					data : { _id : postNum }
				}).done( (results) => {
					location.href = '/listpost';
				}).fail( (xhr, textStatus, errThrown) => {
					console.log("서버에서 보내온 오류 정보 : ", xhr, textStatus, errThrown);
				});
			}
		})
	</script>
	  
	  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
  </body>
</html>